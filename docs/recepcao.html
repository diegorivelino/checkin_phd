<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Recepção — Check-in</title>
  <style>
    :root{--bg1:#0b1220;--bg2:#0f1b33;--card:rgba(255,255,255,.08);--stroke:rgba(255,255,255,.14);--txt:rgba(255,255,255,.92);--mut:rgba(255,255,255,.7);--ok:#38d39f;--err:#ff5a7a;}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;color:var(--txt);background:radial-gradient(1100px 560px at 20% 0%, #1a2a57 0%, transparent 60%),linear-gradient(160deg,var(--bg1),var(--bg2));min-height:100vh;padding:18px}
    .wrap{width:min(980px,100%);margin:0 auto;display:grid;gap:14px}
    .card{border:1px solid var(--stroke);background:linear-gradient(180deg,var(--card),rgba(255,255,255,.05));border-radius:18px;padding:16px;box-shadow:0 18px 60px rgba(0,0,0,.45)}
    h1{margin:0 0 6px;font-size:24px} p{margin:0;color:var(--mut);font-size:13px}
    label{display:block;color:var(--mut);font-size:12px;margin:10px 0 6px}
    input,select{width:100%;padding:12px;border-radius:14px;border:1px solid var(--stroke);background:rgba(0,0,0,.22);color:var(--txt);outline:none}
    button{padding:10px 12px;border:0;border-radius:14px;font-weight:900;color:#06111f;background:linear-gradient(135deg,#62f0c8,#4aa3ff);cursor:pointer}
    .ghost{background:rgba(0,0,0,.18);color:var(--mut);border:1px solid var(--stroke)}
    .msg{margin-top:10px;padding:10px;border-radius:14px;border:1px solid var(--stroke);background:rgba(0,0,0,.18);color:var(--mut);font-size:13px}
    .msg.ok{color:var(--ok)} .msg.err{color:var(--err)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
      <div>
        <h1>Recepção — Check-in</h1>
        <p id="me"></p>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="ghost" onclick="goto('admin.html')">Admin</button>
        <button class="ghost" onclick="goto('atendimento.html')">Atendimento</button>
        <button class="ghost" onclick="logout()">Sair</button>
      </div>
    </div>
    <div id="msg" class="msg">Carregando…</div>
  </div>

  <div class="card">
    <label>Evento</label>
    <select id="evSel"></select>
    <button class="ghost" style="margin-top:10px" onclick="loadEvents()">Atualizar eventos</button>

    <div class="grid" style="margin-top:10px">
      <div>
        <label>Código (4 caracteres)</label>
        <input id="codigo" maxlength="4" placeholder="AB12" />
      </div>
      <div style="display:flex;align-items:flex-end;gap:10px">
        <button onclick="validate()">Validar</button>
        <button class="ghost" onclick="clearAll()">Limpar</button>
      </div>
    </div>

    <div id="card" class="msg" style="display:none"></div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
      <button id="btnCheckin" onclick="checkin()" disabled>Confirmar Check-in</button>
    </div>
  </div>
</div>

<script>
  const WEB_APP_URL = "COLE_AQUI_SUA_URL_DO_WEB_APP";
  const token = localStorage.getItem('auth_token') || '';
  const role = localStorage.getItem('auth_role') || '';
  const username = localStorage.getItem('auth_username') || '';
  document.getElementById('me').textContent = `Logado: ${username} (${role})`;
  function goto(p){ location.href=p; }
  function logout(){ localStorage.clear(); location.href='login.html'; }
  if(!token) logout();

  const msgEl=document.getElementById('msg');
  function setMsg(t,cls=''){ msgEl.className='msg '+cls; msgEl.textContent=t; }
  function esc(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  async function api(obj){
    const form = new URLSearchParams();
    Object.entries(obj).forEach(([k,v])=>form.set(k,v));
    const res = await fetch(WEB_APP_URL,{method:'POST',body:form});
    return await res.json();
  }

  let lastValid = null;

  async function loadEvents(){
    setMsg('Carregando eventos...');
    const data = await api({ action:'events_list', token, include_inactive:'false' });
    if(!data.ok){ setMsg('Erro: '+data.error,'err'); return; }
    const sel=document.getElementById('evSel');
    sel.innerHTML='';
    data.events.forEach(ev=>{
      const o=document.createElement('option');
      o.value=ev.event_id; o.textContent=ev.nome_evento;
      sel.appendChild(o);
    });
    setMsg('OK.','ok');
  }

  async function validate(){
    const event_id = document.getElementById('evSel').value;
    let codigo = document.getElementById('codigo').value.trim().toUpperCase();
    document.getElementById('codigo').value = codigo;

    if(!event_id){ setMsg('Selecione o evento.','err'); return; }
    if(codigo.length!==4){ setMsg('Código inválido (4 caracteres).','err'); return; }

    setMsg('Validando...');
    const data = await api({ action:'validate_code', token, event_id, codigo });
    if(!data.ok){
      setMsg('Erro: '+data.error,'err');
      document.getElementById('card').style.display='none';
      document.getElementById('btnCheckin').disabled=true;
      lastValid=null;
      return;
    }

    lastValid = { event_id, codigo, checkinFeito: !!(data.checkin && data.checkin.feito) };

    const c=document.getElementById('card');
    c.style.display='block';
    c.className='msg '+(lastValid.checkinFeito ? 'err':'ok');
    c.innerHTML =
      `<b>${esc(data.inscrito.nome)}</b><br>`+
      `Dia: <b>${esc(data.inscrito.day_label)}</b><br>`+
      `E-mail: ${esc(data.inscrito.email)}<br>`+
      `Código: <b>${esc(data.inscrito.codigo)}</b><br>`+
      (lastValid.checkinFeito ? `<br>⚠️ Check-in já realizado.` : `<br>✅ Check-in pendente.`);

    document.getElementById('btnCheckin').disabled = lastValid.checkinFeito;
    setMsg('OK.','ok');
  }

  async function checkin(){
    if(!lastValid){ setMsg('Valide um código antes.','err'); return; }
    setMsg('Confirmando check-in...');
    const data = await api({ action:'checkin', token, event_id:lastValid.event_id, codigo:lastValid.codigo });
    if(!data.ok){ setMsg('Erro: '+data.error,'err'); return; }
    setMsg('Check-in confirmado!','ok');
    await validate();
  }

  function clearAll(){
    document.getElementById('codigo').value='';
    document.getElementById('card').style.display='none';
    document.getElementById('btnCheckin').disabled=true;
    lastValid=null;
    setMsg('Pronto.','');
  }

  document.getElementById('codigo').addEventListener('input', (e)=>{
    e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,4);
  });

  loadEvents();
</script>
</body>
</html>
